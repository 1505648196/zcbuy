<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>添加用户</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="static/lib/layui/layui.all.js"></script>
    <link rel="stylesheet" href="static/lib/layui/css/layui.css">
    <script type="text/javascript" src="static/lib/tableSelect.js"></script>
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<form class="layui-form layui-form-pane ok-form">

    <div class="layui-form-item">
        <label class="layui-form-label">单选</label>
        <div class="layui-input-inline">
            <input type="text" name="" placeholder="请输入" autocomplete="off" class="layui-input" id="demo2">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品名字：</label>
        <div class="layui-input-block">
            <select id="goods" name="goods" class="layui-input" lay-filter="goods" autocomplete="off" lay-search >
            </select>
        </div>
    </div>

    <div class="layui-form-item" style="color: red">
        <label class="layui-form-label">申请用户：</label>
        <div class="layui-input-block">
            <select id="applyuser" name="applyuser" class="layui-input" lay-filter="relation"  lay-verify="required" lay-search></select>
        </div>
    </div>

    <div class="layui-form-item" style="color: red">
        <label class="layui-form-label">数量：</label>
        <div class="layui-input-block" >
            <input  type="number" style="color: red" id="quantity" name="quantity" class="layui-input" autocomplete="off"  lay-verify="required|number" >
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">(元)价格：</label>
        <div class="layui-input-block">
            <input type="number" id="price" name="price" class="layui-input" lay-verify="required" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">(元)总金额:</label>
        <div class="layui-input-block">
            <input type="text"  style="color: red" id="sum" name="sum" lay-filter="sum" class="layui-input" autocomplete="off" readonly="readonly">
        </div>

    </div>


    <div class="layui-form-item">
        <label class="layui-form-label">状态：</label>
        <div class="layui-input-block">
            <input type="text" id="statusName" name="statusName" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品类型：</label>
        <div class="layui-input-block">
            <input type="text" id="goodsTypeName" name="goodsTypeName" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">供应商：</label>
        <div class="layui-input-block">
            <input type="text" id="userName" name="userName" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">手机号：</label>
        <div class="layui-input-block">
            <input type="text" id="phone" name="phone" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">邮箱：</label>
        <div class="layui-input-block">
            <input type="text" id="email" name="email" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">公司：</label>
        <div class="layui-input-block">
            <input type="text" id="unitName" name="unitName" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">公司地址：</label>
        <div class="layui-input-block">
            <input type="text" id="address" name="address" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div id="laobao">
        <!--劳保显示-->
    </div>

    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">订单备注：</label>
        <div class="layui-input-block">
            <textarea name="desc" style="color: red" id="desc" placeholder="请输入内容" class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button lay-submit class="layui-btn layui-btn-lg layui-btn-radius " id="sub" lay-filter="sub"><i class="layui-icon">&#xe605;</i>立刻提交</button>
            <button type="reset" class="layui-btn layui-btn-lg layui-btn-radius layui-btn-warm"><i class="layui-icon">&#xe9aa;</i>重置内容</button>
        </div>
    </div>

    <input type="hidden" id="id" name="id"/>
    <input type="hidden" id="happen" name="happen"/>
    <input type="hidden" id="taskId" name="taskId"/>
    <input type="hidden" th:value="${session.userMsg.id}" id="userId"/>
</form>
</body>

<script th:inline="none">

        var form = layui.form;
        form.render();
        var tableSelect = layui.tableSelect;

        tableSelect.render({
            elem: '#demo',
            searchKey: 'my',
            checkedKey: 'id',
            searchPlaceholder: '自定义文字和name',
            table: {
                url: 'getGoods',
                parseData://转换layui所需格式
                    function (res) { //res 即为原始返回的数据
                        var code = 0;
                        if (!res.result) {
                            code = 1;
                        }
                        return {
                            "code": code,
                            "msg": res.msg,
                            "count": res.count,
                            "data": res.data
                        };
                    },
                cols: [
                    [
                    { type: 'radio' },
                    { field: 'id', title: 'ID' },
                    { field: 'id', title: 'ID', width: 100 },
                    { field: 'statusName', title: '状态', width: 100, align: 'center', toolbar: "#statusTp3" },
                    { field: 'createTime', title: '创建时间', align: 'center', },
                    {
                        field: 'userName', title: '供应商', align: 'center', templet: function (d) {
                            return d.user.name;
                        }
                    },
                ]
                ]
            },
            done: function (elem, data) {
                var NEWJSON = []
                layui.each(data.data, function (index, item) {
                    NEWJSON.push(item.username)
                })
                elem.val(NEWJSON.join(","))
            }
        })

        tableSelect.render({
            elem: '#demo2',
            searchKey: 'my',
            checkedKey: 'id',
            searchPlaceholder: '自定义文字和name',
            table: {
                url: 'getGoods',
                parseData://转换layui所需格式
                    function (res) { //res 即为原始返回的数据
                        var code = 0;
                        if (!res.result) {
                            code = 1;
                        }
                        return {
                            "code": code,
                            "msg": res.msg,
                            "count": res.count,
                            "data": res.data
                        };
                    },
                cols: [
                    [
                    { type: 'radio' },
                    { field: 'id', title: 'ID' },
                    { field: 'id', title: 'ID', width: 100 },
                    { field: 'statusName', title: '状态', width: 100, align: 'center', toolbar: "#statusTp3" },
                    { field: 'createTime', title: '创建时间', align: 'center', },
                    {
                        field: 'userName', title: '供应商', align: 'center', templet: function (d) {
                            return d.user.name;
                        }
                    },
                ]
                ]
            },
            done: function (elem, data) {
                var NEWJSON = []
                layui.each(data.data, function (index, item) {
                    NEWJSON.push(item.username)
                })
                elem.val(NEWJSON.join(","))
            }
        })


</script>
<script th:inline="none">
    layui.use(["element", "form", "laydate", "okLayer", "okUtils","jquery",], function () {
        var form = layui.form;
        var laydate = layui.laydate;
        var okLayer = layui.okLayer;
        var okUtils = layui.okUtils;
        $ = layui.jquery; //jquery控件

        laydate.render({elem: "#birthday", type: "datetime"});

        form.verify({
            birthdayVerify: [/^((((1[6-9]|[2-9]\d)\d{2})-(0?[13578]|1[02])-(0?[1-9]|[12]\d|3[01]))|(((1[6-9]|[2-9]\d)\d{2})-(0?[13456789]|1[012])-(0?[1-9]|[12]\d|30))|(((1[6-9]|[2-9]\d)\d{2})-0?2-(0?[1-9]|1\d|2[0-8]))|(((1[6-9]|[2-9]\d)(0[48]|[2468][048]|[13579][26])|((16|[2468][048]|[3579][26])00))-0?2-29-))(\s(([01]\d{1})|(2[0123])):([0-5]\d):([0-5]\d))?$/, '日期格式不正确']
        });

        show();

        function show() {
            var showId = $("#userId").val();
            console.log(showId)
            //可申请用用户  电话下单
            $.get("getUserToOneUnit", {"userId": showId}, function (res) {
                console.log(res)
                var data = res.data;
                var htmltwo = " <option value='' >直接选择或搜索选择</option>";
                $.each(data, function (index, item) {
                    htmltwo += "<option value='" + item.id + "'>" + item.name + "</option>";
                });
                $("#applyuser").html(htmltwo);
                form.render();
            });
        }

        //劳保查询
        function getAllLaobaobu() {
            $.get("getAllLaobaobu", function (res) {
                var data = res.data;
                console.log(res);
                var html = "<option value=''>请选择站车劳保部</option>";
                $.each(data, function (index, item) {
                    html += "<option   value='" + item.id + "'>" + item.name + "</option>";
                    console.log(item.id, item.name)
                });
                $("#labour").html(html);
                form.render();
            })
        }

        getAllGoodsByUserId();

        //根据userId查询旗下的拥有的商品申请权限
        function getAllGoodsByUserId() {
            var userId = $("#userId").val();
            console.log(userId);
            $.get("getAllGoodsByUserId", {"userId": userId}, function (res) {
                console.log(res.msg);
                var data = res.data;
                var html = "<option value=''></option>";
                $.each(data, function (index, item) {
                    html += "<option   value='" + item.id + "'>" + item.name + "</option>";
                });
                $("#goods").html(html);
                form.render();
            })
        }

        var goodsId;
        var purchaseTypeId;
        form.on('select(goods)', function (data) {
            var id = data.value;
            $.get("getById", {"id": id}, function (res) {
                console.log(res);
                var data = res.data;
                goodsId = data.id;
                purchaseTypeId = data.purchaseType.id;
                var price = data.price;
                console.log(price);
                var statusName = data.statusName;
                var goodsTypeName = data.goodsType.name;
                var userName = data.user.name;
                var phone = data.user.phone;
                var email = data.user.email;
                var unitName = data.user.unit.name;
                var address = data.user.unit.address;
                var purchaseTypeName = data.purchaseType.name;
                console.log(purchaseTypeName);
                if (purchaseTypeName == "劳保用品") {
                    var htmlLaoBao = "<div class=\"layui-form-item\" style='color: red'>\n" +
                        "            <label class=\"layui-form-label\">站车劳保部:</label>\n" +
                        "            <div class=\"layui-input-block \">\n" +
                        "                <select id=\"labour\" name=\"labour\" class=\"layui-input\" lay-filter=\"labour\"  lay-verify=\"required\">\n" +
                        "                </select>\n" +
                        "            </div>\n" +
                        "        </div>";
                    $("#laobao").html(htmlLaoBao);
                    getAllLaobaobu()
                }
                console.log(userName, phone, email, unitName, address.purchaseType);
                $("#price").val(divideByHundred(price));
                $("#statusName").val(statusName);
                $("#goodsTypeName").val(goodsTypeName);
                $("#userName").val(userName);
                $("#phone").val(phone);
                $("#email").val(email);
                $("#unitName").val(unitName);
                $("#address").val(address);
            })

        });

        //ES6语法
        function divideByHundred(str) {
            let floatVal = parseFloat(str);
            if (isNaN(floatVal)) {
                return false;
            }
            floatVal = Math.round(str * 100) / 10000;
            let strVal = floatVal.toString();
            let searchVal = strVal.indexOf('.');
            if (searchVal < 0) {
                searchVal = strVal.length;
                strVal += '.';
            }
            while (strVal.length <= searchVal + 2) {
                strVal += '0';
            }
            return strVal;
        }


        $("#quantity").bind('input propertychange', function () {
            var a = $("#price").val();
            var b = $("#quantity").val();
            var c = parseFloat(a * b).toFixed(2);//保留两位
            $("#sum").val(c);
        });


        var context = "";
        form.on('submit(sub)', function (data) {
            var happen = $("#happen").val();
            var purchaseRequisitionId = $("#id").val();
            var userId = $("#userId").val();
            console.log(userId)
            var goodsName = $("#goodsName").val();//已被删除
            var quantity = $("#quantity").val();
            var taskId = $("#taskId").val();
            var desc = $("#desc").val();
            console.log(taskId);
            var purchaseTypeName = $("#purchaseTypeName").val();//拿的是id 不是名字
            console.log(purchaseTypeName);
            var arrplus = [];
            var labour = $("#labour").val();
            console.log(labour);
            console.log(purchaseTypeId);
            console.log(purchaseTypeId, goodsId, $("#applyuser").val(), quantity, desc)
            var index = layer.load(0, {time: 10 * 1000});
            if (happen == "edit") {
                //同步
                $.ajaxSetup({
                    async: false
                });

                $.get("selectCandidates",
                    {"userId": userId},
                    function (res) {
                        datas = res.data;
                        $.each(datas, function (index, item) {
                            context += item.id + ","
                        })
                        return context
                    })
                console.log(context);

                $.post("updatePurchaseRequisition",
                    {"id": purchaseRequisitionId, "goodsName": goodsName, "quantity": quantity, "price": priceplus},
                    function (res) {
                        if (res.result) {
                            $.post("taskComplete",
                                //taskId  users  boo_candidate true  boo_delete false boo_pass true PurchaseRequisition
                                {
                                    "taskId": taskId,
                                    "str_users": context,
                                    "boo_candidate": true,
                                    "boo_delete": false,
                                    "boo_pass": true,
                                    "purchaseRequisitionId": purchaseRequisitionId
                                },
                                function (res) {
                                    if (res.result) {
                                        console.log(res.msg);
                                        layer.msg(res.msg, {
                                            time: 1000
                                        }, function () {
                                            //传到爹哪里去
                                            var index = parent.layer.getFrameIndex(window.name);
                                            parent.layer.close(index);
                                            parent.location.reload();
                                            layer.close(index);
                                        });
                                    } else {
                                        layer.msg(res.msg, {
                                            time: 2000
                                        }, function () {
                                            console.log(res.msg)
                                            layer.close(index);
                                        });
                                    }
                                });
                        } else {
                            layer.msg(res.msg, {
                                time: 2000
                            }, function () {
                                console.log(res.msg)
                            });
                        }
                    });
            } else {
                console.log(purchaseTypeId, goodsId, $("#applyuser").val(), quantity, desc, labour);
                $.post("addPurchaseRequisition",
                    {
                        "purchaseTypeId": purchaseTypeId,
                        "goodsId": goodsId,
                        "userId": $("#applyuser").val(),
                        "quantity": quantity,
                        "totalPrice": "",
                        "comment": desc,
                        "unitId": labour,
                    }
                    ,
                    function (res) {
                        if (res.result) {
                            console.log(res.msg);
                            layer.msg(res.msg, {
                                time: 2000
                            }, function () {
                                //传到爹哪里去
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                parent.location.reload();
                                layer.close(index);
                            });
                        } else {
                            layer.msg(res.msg, {
                                time: 20000
                            });
                            layer.close(index);
                        }
                    });
            }

            return false;
        });
    })
</script>


</html>